<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è”¬èœå¤§æ£šåœŸå£¤å¢’æƒ…ç›‘æµ‹å¹³å° - å®æ—¶ç›‘æ§</title>
    <!-- Bootstrap + ECharts CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <style>
        body { background: #f8f9fa; }
        .card { transition: all 0.3s; }
        .card.alert { border-color: #dc3545; background: #fff5f5; }
        .status-normal { color: #28a745; }
        .status-alert { color: #dc3545; animation: flash 1s infinite; }
        @keyframes flash { 50% { opacity: 0.6; } }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">ğŸŒ± è”¬èœå¤§æ£šåœŸå£¤å¢’æƒ…ç›‘æµ‹å¹³å°</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link active" href="/">å®æ—¶ç›‘æ§</a>
                <a class="nav-link" href="/history">å†å²æ•°æ®</a>
                <a class="nav-link" href="/threshold">é˜ˆå€¼è®¾ç½®</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2 class="text-center mb-4">å®æ—¶åœŸå£¤å¢’æƒ…ç›‘æ§</h2>

        <!-- èŠ‚ç‚¹æ•°æ®å¡ç‰‡ -->
        <div class="row g-3" id="nodeCards">
            <!-- JS åŠ¨æ€ç”Ÿæˆ 3 ä¸ªå¡ç‰‡ -->
        </div>

        <!-- å®æ—¶æ›²çº¿å›¾ -->
        <div class="card mt-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">åœŸå£¤æ¸©æ¹¿åº¦å®æ—¶å˜åŒ–è¶‹åŠ¿</h5>
            </div>
            <div class="card-body">
                <div id="realtime-chart" style="width: 100%; height: 500px;"></div>
            </div>
        </div>

        <!-- é¢„è­¦ä¿¡æ¯ -->
        <div class="alert alert-info mt-3" id="alertBox" style="display: none;">
            <strong>âš ï¸ é¢„è­¦æç¤ºï¼š</strong> <span id="alertContent"></span>
        </div>
    </div>

    <script>
        let myChart = echarts.init(document.getElementById('realtime-chart'));
        let chartOption = {
            title: { text: 'å®æ—¶å¢’æƒ…æ›²çº¿', left: 'center' },
            tooltip: { trigger: 'axis' },
            legend: { data: ['æ¸©åº¦(â„ƒ)', 'æ¹¿åº¦(%RH)'], top: 20 },
            xAxis: { type: 'time', boundaryGap: false },
            yAxis: [
                { name: 'æ¸©åº¦(â„ƒ)', type: 'value', min: 0, max: 50 },
                { name: 'æ¹¿åº¦(%RH)', type: 'value', min: 0, max: 100, offset: 60 }
            ],
            series: [
                { name: 'æ¸©åº¦(â„ƒ)', type: 'line', yAxisIndex: 0, data: [], smooth: true, lineStyle: { width: 3 } },
                { name: 'æ¹¿åº¦(%RH)', type: 'line', yAxisIndex: 1, data: [], smooth: true, lineStyle: { width: 3 } }
            ]
        };
        myChart.setOption(chartOption);

        function updateRealtime() {
            // è·å–å®æ—¶æ•°æ®
            fetch('/api/realtime')
                .then(res => res.json())
                .then(res => {
                    if (res.code !== 200) return;

                    const nodes = res.data;
                    let html = '';

                    Object.keys(nodes).forEach(node => {
                        const d = nodes[node];
                        const isAlert = d.temp < 15 || d.temp > 30 || d.hum < 40 || d.hum > 80; // ç¤ºä¾‹é˜ˆå€¼ï¼Œå¯è‡ªè¡Œè°ƒæ•´
                        html += `
                            <div class="col-md-4">
                                <div class="card h-100 ${isAlert ? 'alert' : ''}">
                                    <div class="card-body">
                                        <h5 class="card-title">${node} <span class="badge bg-${isAlert ? 'danger' : 'success'}">${isAlert ? 'å¼‚å¸¸' : 'æ­£å¸¸'}</span></h5>
                                        <p class="mb-1">æ¸©åº¦ï¼š<strong>${d.temp} â„ƒ</strong></p>
                                        <p class="mb-1">æ¹¿åº¦ï¼š<strong>${d.hum} %RH</strong></p>
                                        <small class="text-muted">æ›´æ–°æ—¶é—´ï¼š${d.collect_time}</small>
                                    </div>
                                </div>
                            </div>`;
                    });
                    document.getElementById('nodeCards').innerHTML = html;
                });

            // æ›´æ–°æ›²çº¿
            fetch('/api/realtime')
                .then(res => res.json())
                .then(res => {
                    if (res.code !== 200) return;
                    const nodeData = res.data.Node1 || Object.values(res.data)[0];
                    if (!nodeData) return;

                    const now = new Date().getTime();
                    const series = myChart.getOption().series;

                    series[0].data.push([now, parseFloat(nodeData.temp)]);
                    series[1].data.push([now, parseFloat(nodeData.hum)]);

                    if (series[0].data.length > 60) {
                        series[0].data.shift();
                        series[1].data.shift();
                    }

                    myChart.setOption({ series: series });
                });

            // é¢„è­¦çŠ¶æ€
            fetch('/api/alert')
                .then(res => res.json())
                .then(res => {
                    if (res.code === 200) {
                        const alerts = Object.values(res.data).filter(a => a.status === 'alert');
                        const box = document.getElementById('alertBox');
                        if (alerts.length > 0) {
                            box.style.display = 'block';
                            box.innerHTML = `<strong>âš ï¸ å½“å‰é¢„è­¦ï¼š</strong> ${alerts.map(a => a.msg).join('ï¼›')}`;
                        } else {
                            box.style.display = 'none';
                        }
                    }
                });
        }

        // ç«‹å³åˆ·æ–° + æ¯3ç§’åˆ·æ–°
        updateRealtime();
        setInterval(updateRealtime, 3000);

        // è‡ªé€‚åº”å›¾è¡¨
        window.addEventListener('resize', () => myChart.resize());
    </script>

    <footer class="text-center py-3 mt-5 text-muted">
        Â© 2026 ç‹å¥ å¤§è¿ä¸œè½¯ä¿¡æ¯å­¦é™¢ | GitHub: 20247140130
    </footer>
</body>
</html>
